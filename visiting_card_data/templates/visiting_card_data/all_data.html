{% extends 'visiting_card_data/base.html' %}

{% load static %}

{% block stylesheets %}
<link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

{% endblock stylesheets %}


{% block content %}

<div id="content">
	<div class="container-fluid">
		<button type="button" id="sidebarCollapse" class="btn btn-info">
			<i class="fas fa-align-left"></i>
		</button>
		<hr>

		<h2>All Data<span style="float: right">
        <div class="row">
    <h3>ADD USER</h3>
         <form id="addUser" action="">
          <div class="form-group">
            <input class="form-control" type="text" name="cname" placeholder="Name" required>
          </div>
          <div class="form-group">
            <input class="form-control" type="text" name="aname" placeholder="Address" required>
          </div>
          <div class="form-group">
            <input class="form-control" type="text" name="designation" placeholder="Age" required>
          </div>
           <div class="form-group">
            <input class="form-control" type="text" name="mobile_no1" placeholder="Age" required>
          </div>
           <div class="form-group">
            <input class="form-control" type="text" name="mobile_no2" placeholder="Age" required>
          </div>
           <div class="form-group">
            <input class="form-control" type="text" name="email_id1" placeholder="Age" required>
          </div>
           <div class="form-group">
            <input class="form-control" type="text" name="email_id2" placeholder="Age" required>
          </div>
          <button class="btn btn-primary form-control" type="submit">SUBMIT</button>
        </form> 
        </div>
        <button class="create-email btn btn-info" type="button" name="button">Create New Email Template</button></span></h2>

		<hr>
		<div>

			<table id="test_table" class="display" style="width:100%; text-align:center">
				<thead>
					<tr>
						<th>Serial No.</th>
                        <th>Company Name</th>
                        <th>Agent Name</th>
                        <th>Agent Destination</th>
                        <th>Mobile No.1</th>
                        <th>Mobile No.2</th>
                        <th>Email id.1</th>
                        <th>Email id.2</th>
						<th>Update</th>
						<th>Delete</th>


					</tr>
				</thead>
				<tbody>
					 {% for visiting_card in all_visiting_cards_data %}
                     <tr id="visiting_card-{{visiting_card.id}}">
                   <th class="text-center" scope="row">{{ forloop.counter }}</th>
                        <td class="userCName userData" name="Cname">{{ visiting_card.visitingcardcompanydata_company_name }}</td>
                        <td class="userAName userData" name="Aname">{{ visiting_card.visitingcardcompanydata_agent_name }}</td>
                        <td class="userDName userData" name="Dname">{{ visiting_card.visitingcardcompanydata_agent_designation }}</td>
                        <td class="userM1Name userData" name="M1name">{{ visiting_card.visitingcardcompanydata_mobile_number1 }}</td>
                        <td class="userM2Name userData" name="M2name">{{ visiting_card.visitingcardcompanydata_mobile_number2 }}</td>
                        <td class="userE1Name userData" name="E1name">{{ visiting_card.visitingcardcompanydata_email_id1 }}</td>
                        <td class="userE2Name userData" name="E2name">{{ visiting_card.visitingcardcompanydata_email_id2 }}</td>												
                        <td> <button class="btn btn-success form-control" onClick="editUser({{visiting_card.id}})" data-toggle="modal" data-target="#myModal")>EDIT</button></td>

						<td>  <button class="btn btn-danger form-control" onClick="deleteUser({{visiting_card.id}})">DELETE</button></td>
					</tr>
                    {% endfor %}
				</tbody>
			</table>

			{% comment %} <p class="no-leads text-primary">No entry added yet.</p> {% endcomment %}

		</div>
		<!--TEST TABLE ENDS HERE-->
	</div>
</div>
<!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Update User</h4>
        </div>
        <form id="updateUser" action="">
        <div class="modal-body">
            <input class="form-control" id="form-id" type="hidden" name="formId"/>
            <label for="name">company name</label>
            <input class="form-control" id="form-companyname" type="text" name="formcompanyName"/>
            <label for="address">agent_name</label>
            <input class="form-control" id="form-agentname" type="text" name="formagentname"/>
            <label for="age">agent designation</label>
            <input class="form-control" id="form-designation" type="text" name="formdesignation" />
            <label for="age">mobile_number1</label>
            <input class="form-control" id="form-mobile_no1" type="text" name="formmobile_no1"/>
            <label for="age">mobile_number2</label>
            <input class="form-control" id="form-mobile_no2" type="text" name="formmobile_no2" />
            <label for="age">email_id1</label>
            <input class="form-control" id="form-email_id1" type="text" name="formemail_id1" />
            <label for="age">email_id2</label>
            <input class="form-control" id="form-email_id2" type="text" name="formemail_id2" />

        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" >Save changes</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.1.5/js/dataTables.fixedHeader.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>

{% endblock %}

{% block extrascript %}

<script>

// Create Django Ajax Call
 $("form#addUser").submit(function() {
    var nameInput = $('input[name="name"]').val().trim();
    var addressInput = $('input[name="address"]').val().trim();
    var ageInput = $('input[name="age"]').val().trim();
    if (nameInput && addressInput && ageInput) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "visiting_card_data:crud_ajax_create" %}',
            data: {
                'name': nameInput,
                'address': addressInput,
                'age': ageInput
            },
            dataType: 'json',
            success: function (data) {
                if (data.user) {
                  appendToUsrTable(data.user);
                }
            }
        });

    } else {
        alert("All fields must have a valid value.");
    }
    $('form#addUser').trigger("reset");
    return false;
}); 


// Delete Django Ajax Call
function deleteUser(id) {
  var action = confirm("Are you sure you want to delete this user?");
  if (action != false) {
    $.ajax({
        url: '{% url "visiting_card_data:crud_ajax_delete" %}',
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function (data) {
            if (data.deleted) {
              $("#test_table #visiting_card-" + id).remove();
            }
        }
    });
  }
}


// Create Django Ajax Call
$("form#updateUser").submit(function() {
    var idInput = $('input[name="formId"]').val().trim();
    var companyNameInput = $('input[name="formcompanyName"]').val().trim();
    var agentnameInput = $('input[name="formagentname"]').val().trim();
    var designationInput = $('input[name="formdesignation"]').val().trim();
    var mobile_no1Input = $('input[name="formmobile_no1"]').val().trim();
    var mobile_no2Input = $('input[name="formmobile_no2"]').val().trim();
    var email_id1Input = $('input[name="formemail_id1"]').val().trim();
    var email_id2Input = $('input[name="formemail_id2"]').val().trim();

    if (companyNameInput && agentnameInput && designationInput && mobile_no1Input && mobile_no2Input && email_id1Input && email_id2Input) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "visiting_card_data:crud_ajax_update" %}',
            data: {
                'id': idInput,
                'visitingcardcompanydata_company_name': companyNameInput,
                'visitingcardcompanydata_agent_name': agentnameInput,
                'visitingcardcompanydata_agent_designation': designationInput,
                'visitingcardcompanydata_mobile_number1': mobile_no1Input,
                'visitingcardcompanydata_mobile_number2': mobile_no2Input,
                'visitingcardcompanydata_email_id1': email_id1Input,
                'visitingcardcompanydata_email_id2':email_id2Input
            },
            dataType: 'json',
            success: function (data) {
                if (data.user) {
                  updateToUserTabel(data.user);
                }
            }
        });

    } else {
        alert("All fields must have a valid value.");
    }
    $('form#updateUser').trigger("reset");
    $('#myModal').modal('hide');
    return false;
});


// Update Django Ajax Call
function editUser(id) {
  if (id) {
    tr_id = "#visiting_card-" + id;
    cname = $(tr_id).find(".userCName").text();
    aname = $(tr_id).find(".userAName").text();
    dname = $(tr_id).find(".userDName").text();
    m1name = $(tr_id).find(".userM1Name").text();
    m2name = $(tr_id).find(".userM2Name").text();
    e1name = $(tr_id).find(".userE1Name").text();
    e1name = $(tr_id).find(".userE2Name").text();
    $('#form-id').val(id);
    $('#form-companyname').val(cname);
    $('#form-agentname').val(aname);
    $('#form-designation').val(dname);
    $('#form-mobile_no1').val(m1name);
    $('#form-mobile_no2').val(m2name);
    $('#form-email_id1').val(e1name);
    $('#form-email_id1').val(e2name);

  }
}

function appendToUsrTable(user) {
  $("#test_table > tbody:last-child").append(`
        <tr id="visiting_card-${visiting_card.id}">
            <td class="userCName userData">${visiting_card.visitingcardcompanydata_company_name}</td>
            '<td class="userAName userData">${visiting_card.visitingcardcompanydata_agent_name}</td>
            '<td class="userDName userData">${visiting_card.visitingcardcompanydata_agent_designation}</td>
            '<td class="userM1Name userData">${visiting_card.visitingcardcompanydata_mobile_number1}</td>
            '<td class="userM2Name userData">${visiting_card.visitingcardcompanydata_mobile_number2}</td>
            '<td class="userE1Name userData">${visiting_card.visitingcardcompanydata_email_id1}</td>
            '<td class="userE2Name userData">${visiting_card.visitingcardcompanydata_email_id2}</td>
            '<td align="center">
                <button class="btn btn-success form-control" onClick="editUser(${visiting_card.id})" data-toggle="modal" data-target="#myModal")">EDIT</button>
            </td>
            <td align="center">
                <button class="btn btn-danger form-control" onClick="deleteUser(${visiting_card.id})">DELETE</button>
            </td>
        </tr>
    `);
}

function updateToUserTabel(user){
    $("#test_table #visiting_card-" + visiting_card.id).children(".userData").each(function() {
        var attr = $(this).attr("Cname");
        if (attr == "Cname") {
          $(this).text(visiting_card.visitingcardcompanydata_company_name);
        } else if (attr == "Aname") {
          $(this).text(visiting_card.visitingcardcompanydata_agent_name);
        }else if (attr == "Dname") {
          $(this).text(visiting_card.visitingcardcompanydata_agent_designation);
        }else if (attr == "M1name") {
          $(this).text(visiting_card.visitingcardcompanydata_mobile_number1);
        }else if (attr == "M2name") {
          $(this).text(visiting_card.visitingcardcompanydata_mobile_number2);
        }else if (attr == "E1name") {
          $(this).text(visiting_card.visitingcardcompanydata_email_id1);
        } else {
          $(this).text(visiting_card.visitingcardcompanydata_email_id2);
        }
      });
}
</script>

{% comment %} datatble {% endcomment %}
<script type="text/javascript">
 $(document).ready(function() {
$('#test_table').DataTable({
    orderCellsTop: true,
    fixedHeader: false,
    "lengthMenu": [ [-1], ["All"] ],

 dom: 'Bfrtip',
  buttons: [
    'excelHtml5', 'csvHtml5'
  ]
});
});
</script>
{% endblock %}